<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>leaflet | Michael Luu</title>
    <link>/tag/leaflet/</link>
      <atom:link href="/tag/leaflet/index.xml" rel="self" type="application/rss+xml" />
    <description>leaflet</description>
    <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator><language>en-us</language><lastBuildDate>Sun, 04 Oct 2020 00:00:00 +0000</lastBuildDate>
    <image>
      <url>/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_2.png</url>
      <title>leaflet</title>
      <link>/tag/leaflet/</link>
    </image>
    
    <item>
      <title>Recreating the New York Times mask utilization survey data with the R opensource Leaflet package</title>
      <link>/post/covid19_mask_usage/</link>
      <pubDate>Sun, 04 Oct 2020 00:00:00 +0000</pubDate>
      <guid>/post/covid19_mask_usage/</guid>
      <description>&lt;p&gt;
&lt;a href=&#34;nytimesmap.png&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;We&amp;rsquo;re going to recreate the NY Times mask-use survey data using R and the leaflet open source interactive mapping package. We can start off by loading the data from the New York Times github repository found 
&lt;a href=&#34;https://github.com/nytimes/covid-19-data/tree/master/mask-use&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;url &amp;lt;- &#39;https://raw.githubusercontent.com/nytimes/covid-19-data/master/mask-use/mask-use-by-county.csv&#39;

df &amp;lt;- read_csv(url)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now that we have the data loaded, lets have a look at the data to see what we&amp;rsquo;re working with&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;glimpse(df)
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Rows: 3,142
## Columns: 6
## $ COUNTYFP   &amp;lt;chr&amp;gt; &amp;quot;01001&amp;quot;, &amp;quot;01003&amp;quot;, &amp;quot;01005&amp;quot;, &amp;quot;01007&amp;quot;, &amp;quot;01009&amp;quot;, &amp;quot;01011&amp;quot;, &amp;quot;0...
## $ NEVER      &amp;lt;dbl&amp;gt; 0.053, 0.083, 0.067, 0.020, 0.053, 0.031, 0.102, 0.152, ...
## $ RARELY     &amp;lt;dbl&amp;gt; 0.074, 0.059, 0.121, 0.034, 0.114, 0.040, 0.053, 0.108, ...
## $ SOMETIMES  &amp;lt;dbl&amp;gt; 0.134, 0.098, 0.120, 0.096, 0.180, 0.144, 0.257, 0.130, ...
## $ FREQUENTLY &amp;lt;dbl&amp;gt; 0.295, 0.323, 0.201, 0.278, 0.194, 0.286, 0.137, 0.167, ...
## $ ALWAYS     &amp;lt;dbl&amp;gt; 0.444, 0.436, 0.491, 0.572, 0.459, 0.500, 0.451, 0.442, ...
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;df
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 3,142 x 6
##    COUNTYFP NEVER RARELY SOMETIMES FREQUENTLY ALWAYS
##    &amp;lt;chr&amp;gt;    &amp;lt;dbl&amp;gt;  &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;      &amp;lt;dbl&amp;gt;  &amp;lt;dbl&amp;gt;
##  1 01001    0.053  0.074     0.134      0.295  0.444
##  2 01003    0.083  0.059     0.098      0.323  0.436
##  3 01005    0.067  0.121     0.12       0.201  0.491
##  4 01007    0.02   0.034     0.096      0.278  0.572
##  5 01009    0.053  0.114     0.18       0.194  0.459
##  6 01011    0.031  0.04      0.144      0.286  0.5  
##  7 01013    0.102  0.053     0.257      0.137  0.451
##  8 01015    0.152  0.108     0.13       0.167  0.442
##  9 01017    0.117  0.037     0.15       0.136  0.56 
## 10 01019    0.135  0.027     0.161      0.158  0.52 
## # ... with 3,132 more rows
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;According to the repository, the definitions of the variables are as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;COUNTYFP&lt;/strong&gt;: The county FIPS code.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;NEVER&lt;/strong&gt;: The estimated share of people in this county who would say never in response to the question “How often do you wear a mask in public when you expect to be within six feet of another person?”&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;RARELY&lt;/strong&gt;: The estimated share of people in this county who would say rarely&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;SOMETIMES&lt;/strong&gt;: The estimated share of people in this county who would say sometimes&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;FREQUENTLY&lt;/strong&gt;: The estimated share of people in this county who would say frequently&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ALWAYS&lt;/strong&gt;: The estimated share of people in this county who would say always&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;They are also plotting the probability of encountering a mask usage among 5 random encounters in the county.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The chance all five people are wearing masks in five random encounters is calculated by assuming that survey respondents who answered ‘Always’ were wearing masks all of the time, those who answered ‘Frequently’ were wearing masks 80 percent of the time, those who answered ‘Sometimes’ were wearing masks 50 percent of the time, those who answered ‘Rarely’ were wearing masks 20 percent of the time and those who answered ‘Never’ were wearing masks none of the time.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;We can calculate this simply by using the supplied weights (1, .8, .5, .2, and 0) among ALWAYS, FREQUENTLY, SOMETIMES, RARELY, and NEVER mask usage, and taking the sum of the proportion of mask usage among all 5 different types of individuals that have equal probability of encountering.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;df &amp;lt;- df %&amp;gt;%
  mutate(
    prob = (ALWAYS * 1) + (FREQUENTLY * .8) + (SOMETIMES * .5) + (RARELY * .2) + (NEVER * 0)
  )
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Since we have the county FIPS code data available, we&amp;rsquo;ll need to merge this data with county geojson data for the United States which I was able to obtain from 
&lt;a href=&#34;https://eric.clst.org/tech/usgeojson/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;counties &amp;lt;- rgdal::readOGR(&#39;https://eric.clst.org/assets/wiki/uploads/Stuff/gz_2010_us_050_00_20m.json&#39;)
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## OGR data source with driver: GeoJSON 
## Source: &amp;quot;https://eric.clst.org/assets/wiki/uploads/Stuff/gz_2010_us_050_00_20m.json&amp;quot;, layer: &amp;quot;gz_2010_us_050_00_20m&amp;quot;
## with 3221 features
## It has 6 fields
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After reading in the US counties data, we can merge the mask usage survey data with the geojson file, by the state and FIPS code. We can create a COUNTYFP variable by pasting together the STATE and COUNTY code&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;counties@data &amp;lt;- counties@data %&amp;gt;%
  mutate(
    COUNTYFP = paste0(STATE, COUNTY)
  ) %&amp;gt;%
  left_join(
    df
  )
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Furthermore after merging the data, we can create a label by merging together the % mask usage data into a HTML string&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;counties@data &amp;lt;- counties@data %&amp;gt;%
  mutate(
    label = glue::glue(
      &#39;&amp;lt;h3&amp;gt;{NAME}&amp;lt;/h3&amp;gt;&amp;lt;br&amp;gt;
      {paste0(format(round(NEVER*100, 1), 1), &amp;quot;%&amp;quot;)} estimated NEVER wear a mask &amp;lt;br&amp;gt;
      {paste0(format(round(RARELY*100, 1), 1), &amp;quot;%&amp;quot;)} estimated RARELY wear a mask &amp;lt;br&amp;gt;
      {paste0(format(round(SOMETIMES*100, 1), 1), &amp;quot;%&amp;quot;)} estimated SOMETIMES wear a mask &amp;lt;br&amp;gt;
      {paste0(format(round(FREQUENTLY*100, 1), 1), &amp;quot;%&amp;quot;)} estimated FREQUENTLY wear a mask &amp;lt;br&amp;gt;
      {paste0(format(round(ALWAYS*100, 1), 1), &amp;quot;%&amp;quot;)} estimated ALWAYS wear a mask &amp;lt;br&amp;gt;&amp;lt;br&amp;gt;
      &amp;lt;h5&amp;gt;This translates to a &amp;lt;b&amp;gt;{paste0(format(round(prob*100, 1), 1), &amp;quot;%&amp;quot;)}&amp;lt;/b&amp;gt; chance that everyone is masked in five random encounters&amp;lt;/h5&amp;gt;&#39;
    ),
    label = map(label, ~ htmltools::HTML(.x))
  )
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Finally, let&amp;rsquo;s put this all together and create a Chloropleth map using the leaflet package&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-r&#34;&gt;color_pal &amp;lt;- colorNumeric(&#39;viridis&#39;, counties$prob)

map &amp;lt;- leaflet(counties) %&amp;gt;%
  addTiles() %&amp;gt;%
  fitBounds(lng1 = -131.519605, lng2 = -64.312607, lat1 = 50.623510, lat2 = 23.415249) %&amp;gt;%
  addPolygons(
    fillColor = ~ color_pal(prob),
    fillOpacity = .75,
    weight = 1,
    color = &#39;black&#39;,
    label = ~ label
  ) %&amp;gt;%
  addLegend(
    position = &#39;bottomright&#39;,
    pal = color_pal,
    values = ~ counties$prob,
    title = &#39;% Always Mask Usage&#39;,
    labFormat = labelFormat(
      suffix = &#39;%&#39;,
      transform = function(x)
        x * 100
    )
  )

widgetframe::frameWidget(map, height = 600)
&lt;/code&gt;&lt;/pre&gt;
&lt;!--html_preserve--&gt;&lt;div id=&#34;htmlwidget-4986b38ba31af394600f&#34; style=&#34;width:100%;height:600px;&#34; class=&#34;widgetframe html-widget&#34;&gt;&lt;/div&gt;
&lt;script type=&#34;application/json&#34; data-for=&#34;htmlwidget-4986b38ba31af394600f&#34;&gt;{&#34;x&#34;:{&#34;url&#34;:&#34;/post/covid19_mask_usage/index_files/figure-html//widgets/widget_unnamed-chunk-7.html&#34;,&#34;options&#34;:{&#34;xdomain&#34;:&#34;*&#34;,&#34;allowfullscreen&#34;:false,&#34;lazyload&#34;:false}},&#34;evals&#34;:[],&#34;jsHooks&#34;:[]}&lt;/script&gt;&lt;!--/html_preserve--&gt;
</description>
    </item>
    
  </channel>
</rss>
